Для перюключения языка документации на английский перейдите по [ссылке](./README.md).
<hr>

# Установка YDB с помощью Ansible

Репозиторий содержит готовые шаблоны для развертывания кластера YDB на серверах с учетом моделей избыточности `mirror-3-dc` и `block-4-2`. Шаблоны могут быть масштабированы в зависимости от задач. Для скачивания репозитория используйте команду `git clone https://github.com/ydb-platform/ydb-ansible-examples.git`.

## Необходимые зависимости, внешние файлы и требования к серверам { #requirements }

Обратите внимание на то, что машина на которую, скачивается репозиторий должна отвечать следующим требованиям: 
* Python 3 версии 3.10+.
* Ansible core не ниже версии 2.15.2.
* Сетевая связность с серверами, на которые будет установлен YDB.

Минимальное количество серверов для развертывания YDB – восемь машин для типа избыточности `block-4-2` и девять машин для типа избыточности `mirror-3-dc`. Сервера должны отвечать следующим требованиям:
* 16 ядер CPU.
* 16 GB RAM.
* SSD/HDD от 120 GB.
* SSH-доступ по ключу.
* Локальная DNS зона.
* Выход в интернет.

Для подключения Ansible к серверам понадобится заранее подготовленный SSH-ключ, который нужно разместить в корневой директории скаченного репозитория и указать его имя в переменной `ansible_ssh_private_key_file` инвентаризационного файла `50-inventory.yaml` выбранного или клонированного шаблона.

Также в корневую директорию скаченного репозитория нужно загрузить [архив](https://ydb.tech/docs/ru/downloads/#ydb-server) YDB актуальной версии и указать название архива в переменной `ydb_archive` инвентаризационного файла `50-inventory.yaml`.

Для работы плейбука `setup_playbook.yaml`, который выполняет сценарий развертывания кластера YDB необходимо установить коллекции для Ansible `ydb_platform.ydb` и `community.general`. Коллекции устанавливаются командой `ansible-galaxy install -r requirements.yaml`. После установки коллекций можно адаптировать готовый шаблон из репозитория или создать собственный шаблон клонированием готового шаблона.

## Структура шаблонов развертывания кластера 
Директории шаблонов (`8-nodes-block-4-2` и `9-nodes-mirror-3-dc`) устроены одинаково:
```
.
├── ansible.cfg                   # Конфигурационный файл Ansible.
├── ansible_vault_password_file   # Пароль для root пользователя YDB.
├── creds                         # Переменные окружения, задающие пользователя YDB и пароль для него.
├── files                         # Поддиректория, содержащая файлы для загрузки на сервер.
│   └── config.yaml               # Конфигурационный файл YDB
├── inventory                     # Поддиректория, содержащая инвентаризационные файлы Ansible
│   ├── 50-inventory.yaml         # Основной инвентаризационный файл, содержащий hosts и var.
│   └── 99-inventory-vault.yaml   # Зашифрованный инвентаризационный файл, содержащий пароль пользователя root.  
└── setup_playbook.yaml           # Плейбук развертывания YDB кластера. 
``` 
Основной файл настроек сценария развертывания YDB – это инвентаризационный файл `50-inventory.yaml`. В нём задаются:
* FQDN хостов, на которых будет развернуто YDB:
    ```yaml
    hosts:
        static-node-1.ydb-cluster.com:
        static-node-2.ydb-cluster.com:
        static-node-3.ydb-cluster.com:
        ...
    ```
*  Переменные настроек кластера и его развертывания:
    + `ansible_user` – пользователь для подключения Ansible по SSH.
    + `ansible_ssh_private_key_file` – путь к приватной части SSH-ключа, который будет использовать Ansible для подключения к серверам.
    + `system_timezone` – тайм зона.
    + `system_ntp_servers` – список IP-адресов NTP-серверов для синхронизации времени на серверах.
    + `ydb_archive` – путь к архиву YDB для установки на сервер.
    + `ydb_config` – путь к конфигурационному файлу YDB.
    + `ydb_tls_dir` – путь к директории с TLS-сертификатами.
    + `ydb_user` – имя пользователя YDB, которое будет зарегистрировано в СУБД.
    + `ydb_cores_static` – количество CPU ядер, выделяемых для статической ноды. 
    + `ydb_disks`:
        - `name`: /dev/vdb – путь к блочному устройству, на котором будет размещаться база данных.
        - `label`: ydb_disk_1 – наименования лейбла, которое будет присвоено блочному устройству.
    + `ydb_allow_format_drives` – переменная, задающая условие форматирования присоединённого блочного устройства. 
    + `ydb_skip_data_loss_confirmation_prompt` – переменная, определяющая отмену подтверждения пользователем форматирования диска (по умолчанию уведомление не выводится).  
    + `ydb_domain` – наименования домена (кластера YDB).
    + `ydb_dbname` – название базы данных, которая будет автоматически создана после развертывания кластера.
    + `ydb_pool_kind` – тип диска. Может быть ssd или hdd.
    + `ydb_database_groups` – количество групп хранения. Переменная имеет фиксированные значения: семь для типа избыточности `8-nodes-block-4-2` и восемь для `9-nodes-mirror-3-dc` вне зависимости от количества серверов. 
    + `ydb_cores_dynamic` – количество CPU ядер для динамических нод (на сервер).
    + `ydb_dynnodes` – наборы инстансов динамических нод с инкрементом смещения IC-порта.
    + `ydb_brokers` – список брокеров.

Другой инвентаризационный файл – `99-inventory-vault.yaml` содержит пароль для root пользователя YDB в зашифрованном виде. По умолчанию пароль – `password`. Для его смены укажите новый пароль в следующем формате:
```yaml
all:
  children:
    ydb:
      vars:
        ydb_password: <new password>
``` 
Затем выполните команду `ansible-vault encrypt inventory/99-inventory-vault.yaml` для шифрования файла. Укажите новый пароль в файле `ansible_vault_password_file`.

Сгенерировать наборы TLS-сертификатов для шифрования трафика между сервера кластера можно с помощью скрипта `ydb-ca-update.sh`, который использует список FQDN серверов из файла `ydb-ca-nodes.txt`. 

При развертывании кластера требуются незначительные изменения конфигурационного файла YDB, который расположен в поддиректории `<template folder>/files/confgi.yaml`. Достаточно внести следующие изменения:
* Указать актуальный набор FQDN серверов в разделе `hosts`:  
  ```yaml
  ...
  hosts:
  - host: static-node-1.ydb-cluster.com
    host_config_id: 1
    walle_location:
      body: 1
      data_center: 'zone-a'
      rack: '1'
  ...    
  ```  
* Актуализировать набор node_id в разделе `blob_storage_config`:
  ```yaml
  ...
  - fail_domains:
      - vdisk_locations:
        - node_id: static-node-1.ydb-cluster.com
          pdisk_category: SSD
          path: /dev/disk/by-partlabel/ydb_disk_1
  ...        
  ```

Остальные секции и настройки конфигурационного файла остаются без изменений.

## Масштабирование YDB кластера 
Для адаптации готовых шаблонов под нужное количество серверов выполните следующие действия:
1. Создайте копию директории с готовым примером (`9-nodes-mirror-3-dc` или `8-nodes-block-4-2`).
2. Укажите FQDN серверов в файле `TLS/ydb-ca-nodes.txt` и выполните скрипт `ydb-ca-update.sh` для генерации наборов TLS сертификатов.
3. Внесите изменения в инвентаризационные файлы шаблона.
4. Внесите изменения в конфигурационный файл YDB.
5. Выполните команду `ansible-playbook setup_playbook.yaml`, находясь в директории клонированного шаблона.

## Проверка работоспособности кластера

В результате выполнения плейбука будет создан кластер YDB, на котором развернута тестовая база данных – `database`, создан `root` пользователь с максимальными правами доступа и запущен Embedded UI на порту 8765. Для подключения к Embedded UI можно настроить SSH-туннелирование. Для этого на локальной машине выполните команду `ssh -L 8765:localhost:8765 -i <ssh private key> <user>@<first ydb static node ip>`. После успешной установки соединения можно перейти по URL [localhost:8765](http://localhost:8765).
